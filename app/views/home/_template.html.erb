<%= hidden_field_tag "clicked", "" %>
<%= hidden_field_tag "index", "" %>
<span class="badge badge-success"> Page <%= params[:page].blank? ? 1 : params[:page] %> </span>
<%= link_to "Back", "/index?id=#{params[:id]}&page=#{params[:page].to_i - 1}", :class => "btn btn-success" if !params[:id].blank? and params[:page].to_i > 1 %>
<%= form_for :album, :url => "albumes/#{album_exist(@album, @album_details) == true ? 'create_album' : 'update_album'}?template_id=#{@template.id}&new_album=#{@album.new_record? ? nil : @album.id}", :html => {:multipart => true} do |f| %>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="ga-svg-cont" class="ga-svg-cont">
      <svg xmlns="http://www.w3.org/2000/svg" version="1.1" onclick="open_dialog_svg(this)" style="background: <%= album_exist(@album, @album_details) == false ? "url('#{@svg_background.photo.url}')" : '' %>" version="1.1" height="475" width="800" id="templates-container" preserveAspectRatio="none">
        <% if album_exist(@album, @album_details) %>
            <defs>
              <% @shapes.each_with_index do |s, i| %>
                  <pattern id="img<%= i + 1 %>" patternUnits="userSpaceOnUse" width="100" height="100">
                    <image xlink:href="" x="0" y="0" width="100" height="100" id="bac-image-<%= i + 1 %>"/>
                  </pattern>
              <% end %>
            </defs>
        <% else %>
            <defs>
              <% @album_details.each_with_index do |s, i| %>
                  <pattern id="img<%= i + 1 %>" patternUnits="userSpaceOnUse" width="100" height="100">
                    <image transform="rotate(<%= s.rotate %> 50 50)" xlink:href="<%= s.photo.url(:small) %>" x="0" y="0" width="100" height="100" id="bac-image-<%= i + 1 %>"/>
                  </pattern>
              <% end %>
            </defs>
        <% end %>
        <% if album_exist(@album, @album_details) %>
            <% @shapes.each_with_index do |s, c| %>
                <<%= s.type %> stroke-width="2" fill="white" stroke="white" width="<%= s.width %>"
                height="<%= s.height %>"
                r="<%= s.r %>"
                cy="<%= s.y %>" cx="<%= s.x %>" id="<%= s.type %><%= c + 1 %>" x="<%= s.x %>" y="<%= s.y %>"
                class="ga-svg droppable" alt="<%= c + 1 %>"
                onclick="<%= user_signed_in? ? 'open_dialog(this)' : 'open_file(this)' %>"/>
            <% end %>
        <% else %>
            <% @album_details.each_with_index do |s, c| %>
                <<%= s.shape.type %> stroke-width="2" fill="url(#img<%= c + 1 %>)" stroke="white"
                width="<%= s.shape.width %>"
                height="<%= s.shape.height %>"
                r="<%= s.shape.r %>"
                cy="<%= s.shape.y %>" cx="<%= s.shape.x %>" id="<%= s.shape.type %><%= c + 1 %>" x="<%= s.shape.x %>"
                y="<%= s.shape.y %>"
                class="ga-svg droppable" alt="<%= c + 1 %>"
                onclick="<%= user_signed_in? ? 'open_dialog(this)' : 'open_file(this)' %>"/>
            <% end %>
        <% end %>
      </svg>
    </div>
    <% if album_exist(@album, @album_details) %>
        <% @shapes.each_with_index do |s, c| %>
            <%= hidden_field_tag "image#{ c + 1}", 0 %>
            <%= file_field_tag "file_opener#{ c + 1}", :class => "file_opener", :style => "display: none" %>
            <%= hidden_field_tag "image_type#{ c + 1}" "" %>
            <%= hidden_field_tag "shape_id#{ c + 1}", s.id %>
            <%= hidden_field_tag "fb_url#{ c + 1}", "" %>
        <% end %>
        <%= hidden_field_tag "shapes_count", @shapes.count %>

    <% else %>
        <% @album_details.each_with_index do |s, c| %>
            <%= hidden_field_tag "image#{ c + 1}", s.rotate %>
            <%= file_field_tag "file_opener#{ c + 1}", :class => "file_opener", :style => "display: none" %>
            <%= hidden_field_tag "image_type#{ c + 1}", s.image_type %>
            <%= hidden_field_tag "shape_id#{ c + 1}", s.shape_id %>
            <%= hidden_field_tag "fb_url#{ c + 1}", "" %>
        <% end %>
        <%= hidden_field_tag "shapes_count", @album_details.count %>
    <% end %>
    <%= hidden_field_tag "page", params[:page].blank? ? 1 : params[:page] %>
    <%= file_field_tag "file_openersvg-index", :class => "file_opener", :style => "display: none" %>
    <%= hidden_field_tag "svg_fb_url", "" %>
    <%= hidden_field_tag "svg_image_type", "" %>

    <%= f.submit "#{album_exist(@album, @album_details) == true ? 'Save & Next' : 'Update & Next' }", :class => "btn btn-primary" %>
<% end %>
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none">
  <%= render "shared/images_select" %>
</div>
<!-- Modal end -->
<%= link_to "Download", "javascript:", :onclick => "download_svg()" %>
<%= render "home/template_js" %>

<script type="text/javascript">
    function download_svg() {
        svg = $('#ga-svg-cont').html();
//        svg = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1100" height="600"><g stroke="red" stroke-width="0.500" fill="none" transform="scale(1.000)"><path id="frame" d="M 40.000 40.000  l 820 0 0 440 -820 0 0 -440"></path><path id="frame" d="M 0 0  l 900 0 0 520 -900 0 0 -520" stroke="black"></path></g><g stroke="red" stroke-width="0.500" fill="none" transform="scale(1.000)"><path id="lines" d="M 0 40.000  l 1800 0 m -1800 60 l 1800 0 m -1800 40 l 1800 0 m -1800 20 l 1800 0 m -1800 40 l 1800 0" stroke="white"></path><path id="bult1" d="M 42.000 220.000  c 42.500 -51 72.250 -76.500 56.950 -62.900 m 13.600 -34 l 4.250 8.500 m -17.850 25.500 c 20.400 -17 -96.900 153 -30.600 85 66.300 -68 109.905 -117.810 99.450 -90.100 -1.870 5.100 -5.100 -17 -7.650 5.100 -5.100 44.200 -14.450 130.900 -79.050 79.900 32.300 25.500 54.400 0 77.350 -18.700 22.950 -18.700 96.815 -91.630 84.150 -32.300 8.925 -41.650 -34 -34 -59.500 17 -7.650 15.300 -12.750 66.300 14.450 45.900 2.720 -2.040 20.400 -13.600 22.950 -15.300 2.550 -1.700 27.880 -14.960 67.150 -73.100 15.980 -23.800 -44.200 20.400 63.750 -8.500 -43.180 11.560 -88.400 102 -73.100 102 15.300 0 90.950 -113.900 73.950 -96.900 m 13.600 -34 l 4.250 8.500 m -17.850 25.500 c 20.400 -17 -96.900 153 -30.600 85 66.300 -68 71.655 -75.310 70.550 -90.100 0 3.400 -81.600 170 -93.500 170 -2.380 0 51 -102 81.600 -136 100.980 -112.200 -17 153 -17 34 0 45.220 25.500 17 51 0 25.500 -17 110.500 -153 68 -85 8.500 -13.600 -59.500 102 -68 119 51 -102 -8.500 -34 17 -34 25.500 0 97.750 -93.500 85 -34 14.025 -65.450 -34 -34 -59.500 17 -20.400 40.800 -22.950 147.900 119 -136 -14.195 28.390 -80.750 161.500 -86.700 173.400 -11.900 23.800 -0.850 8.500 11.900 0 12.750 -8.500 57.970 -13.940 86.700 -71.400 4.462 -8.925 12.750 -59.500 -51 34 -38.250 56.100 -29.750 59.500 17 34 46.750 -25.500 107.100 -112.200 96.900 -85 -1.870 5.100 -5.100 -17 -7.650 5.100 -5.100 44.200 -14.450 130.900 -79.050 79.900 32.300 25.500 54.400 0 77.350 -18.700 22.950 -18.700 71.315 -74.630 56.100 -61.200 m 13.600 -34 l 4.250 8.500 m -17.850 25.500 c 20.400 -17 -96.900 153 -30.600 85 66.300 -68 109.905 -117.810 96.050 -56.100 14.025 -65.450 -34 -34 -59.500 17 -20.400 40.800 -21.250 110.500 76.500 -51 -68.425 113.050 -93.500 187 -127.500 187 -37.400 0 59.500 -85 85 -102 25.500 -17 46.750 -52.700 68 -85 -4.420 6.800 -51 85 -59.500 102 34 -68 51 -102 85 -102 23.800 0 -45.900 102 -42.500 102 0.680 0 0 0 12.750 -8.500" stroke-width="1.500"></path></g><g stroke="black" stroke-width="1.000" fill="none" transform="scale(1.000)"><path id="bult1" d="M 50.000 370.000 c 8 -8 23 -22 20 -8 2.100 -9.800 -8 -8 -14 4 -1.800 3.600 -3 15.600 3.400 10.800 0.640 -0.480 4.800 -3.200 5.400 -3.600 0.600 -0.400 10.560 -11.520 15.600 -19.200 -1.040 1.600 -14 24 -8.800 24 1.560 0 3.200 0 18 -24 -10.360 16.800 -16 28 -9.600 21.600 6.400 -6.400 26.080 -28.160 23.600 -21.600 -0.440 1.200 -1.200 -4 -1.800 1.200 -1.200 10.400 -3.400 30.800 -18.600 18.800 7.600 6 12.800 0 18.200 -4.400 5.400 -4.400 25.780 -35.560 15.800 -19.600 2 -3.200 -14 24 -16 28 12 -24 -2 -8 4 -8 6 0 27 -30 20 -8 -1 -30 -30 44 -1.200 4 8.640 -12 -0.200 -2.800 0 0 0.200 2.800 6.600 -3.600 12 -12 -1.040 1.600 -12 20 -14 24 8 -16 12 -24 20 -24 5.600 0 -10.800 24 -10 24 -3.200 0 12 -24 20 -24 5.600 0 -10.800 24 -10 24 0.160 0 0 0 3 -2 3 -2 20.300 -24.600 16.400 -20.800 m 3.200 -8 l 1 2 m -4.200 6 c 4.800 -4 -22.800 36 -7.200 20 15.600 -16 7.660 -5.720 16.800 -19.200 3.760 -5.600 -11.600 4.800 13.400 -2 -10 2.720 -16.800 16 -26 24 0.920 -0.800 4 -4 9.800 -1.200 0.580 0.280 -2 4 6 -4 8 -8 24.540 -25.080 21.400 -10.800 3.300 -15.400 -8 -8 -14 4 -4.800 9.600 -5 26 18 -12 -16.100 26.600 -12 24 -10 24 2 0 13.600 -8.800 23.200 -24 25 -40 4.200 -16.400 -10.800 12 -10.500 19.880 3 9.200 9.600 -1.600 9.240 -15.120 -5.600 -0.800 2 0 7.600 0.800 10.120 6.160 17.200 -10.400 17 -40 3 -14 -14 12 -10.200 15.600 -7 14 4 8 11 -6 13.200 -2.400 20 -16 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 m 10 -4 c 8 -8 23 -22 20 -8 3.300 -15.400 -8 -8 -14 4 -4.800 9.600 -5.400 34.800 28 -32 -3.340 6.680 -19 38 -20.400 40.800 -2.800 5.600 -0.200 2 2.800 0 3 -2 13.640 -3.280 20.400 -16.800 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 11 -6 25.200 -26.400 22.800 -20 -0.440 1.200 -1.200 -4 -1.800 1.200 -1.200 10.400 -3.400 30.800 -18.600 18.800 7.600 6 12.800 0 18.200 -4.400 5.400 -4.400 16.780 -17.560 13.200 -14.400 m 3.200 -8 l 1 2 m -4.200 6 c 4.800 -4 -22.800 36 -7.200 20 15.600 -16 25.860 -27.720 22.600 -13.200 3.300 -15.400 -8 -8 -14 4 -4.800 9.600 -5 26 18 -12 -16.100 26.600 -22 44 -30 44 -8.800 0 14 -20 20 -24 6 -4 11 -12.400 16 -20 -1.040 1.600 -12 20 -14 24 8 -16 12 -24 20 -24 5.600 0 -10.800 24 -10 24 0.160 0 0 0 3 -2 m 15 2 c -6 -12 0 -24 8 -24 1.600 0 1 2 -8.800 11.200 -9.800 9.200 -14 20 4.800 4 m 7.600 0.800 c 2.400 -3.200 4.800 0 14.200 -14 3.760 -5.600 -10.400 4.800 15 -2 -10.160 2.720 -20.800 24 -17.200 24 3.600 0 15.400 -6.800 22 -20 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 11 -6 25.200 -26.400 22 -12 3.300 -15.400 -8 -8 -14 4 -4.800 9.600 -5 26 18 -12 -16.100 26.600 -12 24 -10 24 2 0 17.600 -8.800 24 -24 17 -40 3 -14 -14 12 -10.200 15.600 -7 14 4 8 11 -6 19.200 -22.400 15.400 -18.800 m 3.200 -8 l 1 2 m -4.200 6 c 4.800 -4 -22.800 36 -7.200 20 15.600 -16 7.660 -5.720 16.800 -19.200 3.760 -5.600 -11.600 4.800 13.400 -2 -10 2.720 -16.800 16 -26 24 0.920 -0.800 4 -4 9.800 -1.200 0.580 0.280 -2 4 6 -4 8 -8 24.540 -25.080 21.400 -10.800 3.300 -15.400 -8 -8 -14 4 -4.800 9.600 -5 26 18 -12 -16.100 26.600 -12 24 -10 24 2 0 30.400 -44.800 20 -28 2 -3.200 -14 24 -16 28 12 -24 -2 -8 4 -8 6 0 17 -18 13.400 -14.800 m 3.200 -8 l 1 2 m -4.200 6 c 4.800 -4 -22.800 36 -7.200 20 15.600 -16 29.860 -35.720 22.600 -13.200 -1 -30 -30 44 -1.200 4 8.640 -12 -0.200 -2.800 0 0 0.200 2.800 6.600 -3.600 12 -12 -1.040 1.600 -12 20 -14 24 8 -16 12 -24 20 -24 5.600 0 -10.800 24 -10 24 0.160 0 0 0 3 -2"></path></g><g stroke="black" stroke-width="1.000" fill="none" transform="scale(1.000)"><path id="bult1" d="M 600.000 450.000  c 10 -12 17 -18 13.400 -14.800 m 3.200 -8 l 1 2 m -4.200 6 c -4 8 -14 36 -22 36 -8.800 0 14 -20 20 -24 6 -4 9.460 5.080 16.600 -9.200 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 11 -6 7 -4.400 16.200 -18 3.760 -5.600 -10.400 4.800 15 -2 -10.160 2.720 -20.800 24 -17.200 24 3.600 0 31.400 -38.800 24 -16 -1 -30 -30 44 -1.200 4 8.640 -12 -0.200 -2.800 0 0 0.200 2.800 8.800 6.400 16 -8 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 11 -6 11 -12.400 16 -20 -1.040 1.600 -12 20 -14 24 8 -16 12 -24 20 -24 5.600 0 -10.800 24 -10 24 0.160 0 0 0 3 -2 m 11 -6 c 8 -8 23 -22 20 -8 3.300 -15.400 -8 -8 -14 4 -4.800 9.600 -5.400 34.800 28 -32 -3.340 6.680 -19 38 -20.400 40.800 -2.800 5.600 -0.200 2 2.800 0 3 -2 19.640 -23.280 15.800 -19.600 m 3.200 -8 l 1 2 m -4.200 6 c 4.800 -4 -22.800 36 -7.200 20 15.600 -16 19.860 -23.720 16 -20 m 3.200 -8 l 1 2 m -4.200 6 c -4 8 -14 36 -22 36 -8.800 0 14 -20 20 -24 6 -4 7.660 3.080 18.600 -17.200 27 -50 4.200 -16.400 -18.800 28 27.600 -53.280 15 6 7.600 -12 0.740 1.800 1.600 0 -1.200 12 -0.560 2.400 0 0 3 -2 3 -2 12.100 -14.600 17 -22 -1.040 1.600 -12 20 -14 24 8 -16 12 -24 20 -24 5.600 0 -10.800 24 -10 24 -3.200 0 12 -24 20 -24 5.600 0 -10.800 24 -10 24 0.160 0 0 0 3 -2 3 -2 14.300 -4.600 21 -18 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 11 -6 19.200 -22.400 15.400 -18.800 m 3.200 -8 l 1 2 m -4.200 6 c 4.800 -4 -22.800 36 -7.200 20 15.600 -16 19.860 -23.720 16 -20 m 3.200 -8 l 1 2 m -4.200 6 c -4 8 -14 36 -22 36 -8.800 0 14 -20 20 -24 6 -4 9.460 5.080 16.600 -9.200 1.050 -2.100 3 -14 -12 8 -9 13.200 -7 14 4 8 11 -6 7 -4.400 16.200 -18 3.760 -5.600 -10.400 4.800 15 -2 -10.160 2.720 -20.800 24 -17.200 24"></path></g></svg>';
//       WORKING svg = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1"  height="475" width="800"><circle stroke-width="2" fill="url(#img1)" stroke="black" width="" height="" r="55" cy="70" cx="730" id="circle1" x="730" y="70" class="ga-svg droppable" alt="1"></circle></svg>'
        canvg('canvas', svg);
        canvas = document.getElementById("canvas");
        alert($(canvas).attr('id'))
        img_PNG = Canvas2Image.saveAsPNG(canvas);

    }
</script>
